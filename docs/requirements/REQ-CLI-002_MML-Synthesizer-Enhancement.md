# MML Synthesizer CLI 機能改善 要件定義書

## メタ情報

| 項目 | 内容 |
|------|------|
| ドキュメントID | REQ-CLI-002 |
| バージョン | 1.0.0 |
| ステータス | ドラフト |
| 作成日 | 2026-01-11 |
| 最終更新日 | 2026-01-11 |
| 作成者 | req-writer |
| 承認者 | - |
| 関連文書 | REQ-CLI-001_MML-Synthesizer.md (v1.1.0)<br>PROP-20260111-implementation-workflow-gaps.md |

---

## 1. プロジェクト概要

### 1.1 背景

sine-mml v1.0の実装完了後、以下の課題が明らかになりました：

1. **メトロノーム機能の未実装**: CLIフラグは存在するが実際に音が鳴らない（スタブ状態）
2. **ループ再生時の履歴欠落**: ループ再生したMMLが履歴DBに保存されない
3. **BPMオプションの冗長性**: MML内のTコマンドと`--bpm`オプションが重複
4. **音声クリッピングのリスク**: メトロノームと演奏の合成時に音量制限がない
5. **開発プロセスの課題**: CLI-Backend間の統合漏れ、スタブ機能の残存

これらの改善により、ユーザー体験の向上と開発品質の強化を実現します。

### 1.2 目的

- メトロノーム機能を実用レベルに強化（ノイズ音源、ビート選択、音量調節）
- ループ再生でもMMLを確実に履歴保存し、過去の演奏を振り返れるようにする
- BPMオプションを削除し、MML内のTコマンドに一本化してインターフェースを簡潔化
- 音声クリッピングを防止し、どんな組み合わせでも快適な音量で再生
- E2E統合テストとCLI-Backend対応マトリクスで開発品質を保証

### 1.3 ゴール

| 目標 | 成功指標 |
|------|---------|
| メトロノームの実用性向上 | ノイズベースのクリック音、16/8/4ビート選択、音量調節が実装され、`--metronome`オプション利用時に正常に動作 |
| 履歴の網羅性 | ループ再生時も履歴DBに保存され、`sine-mml history`で確認可能 |
| インターフェース簡潔化 | `--bpm`オプション削除、ヘルプテキストとドキュメントから削除 |
| 音質の安定性 | メトロノーム+演奏の合成時にクリッピングゼロ（ノーマライゼーション実装） |
| 開発品質の向上 | E2Eテスト導入、CLI-Backend対応マトリクス作成、PRテンプレート更新 |

### 1.4 スコープ

#### 対象範囲
- メトロノームのクリック音源をノイズベースに変更
- ビート選択機能（16ビート、8ビート、4ビート）の実装
- メトロノーム音量調節の実装
- ループ再生時の履歴登録
- `--bpm`オプションの削除
- 音声クリッピング防止（ノーマライゼーション）
- CLI-Backend対応マトリクス（Capability Matrix）の作成
- E2E統合テストの基盤構築と主要シナリオのテスト追加
- PRテンプレートへの統合テスト項目追加

#### 対象外
- MMLパーサーの拡張（新規コマンド追加等）
- ポリフォニック（和音）対応
- GUI版の開発
- Epic進捗の自動同期（検討事項として記録のみ）

---

## 2. ステークホルダー

### 2.1 ステークホルダー一覧

| 役割 | 担当者/部門 | 関心事 | 影響度 |
|------|------------|--------|--------|
| プロダクトオーナー | - | ユーザー要望への対応、品質向上 | 高 |
| 開発チーム | - | 実装の明確性、テスト可能性 | 高 |
| エンドユーザー | 音楽制作者、趣味プログラマー | メトロノームの使いやすさ、履歴の完全性 | 高 |
| QAエンジニア | - | E2Eテストの網羅性 | 中 |

### 2.2 ユーザーペルソナ

#### ペルソナ1: メトロノームを使いたい作曲者
| 項目 | 内容 |
|------|------|
| 属性 | 20-40代、音楽経験あり |
| 課題 | メトロノーム機能が動作せず、リズム感の確認ができない |
| ニーズ | 16ビート刻みのクリック音で細かいタイミングを確認したい |
| 利用シーン | テンポ感を掴みながらメロディを作曲 |

#### ペルソナ2: ループ再生で試行錯誤する開発者
| 項目 | 内容 |
|------|------|
| 属性 | 30代、プログラミング経験豊富 |
| 課題 | ループ再生したMMLが履歴に残らず、後で見返せない |
| ニーズ | ループで何度も聞いたメロディを履歴から再生したい |
| 利用シーン | 作業用BGMとしてループ再生しながらコーディング |

---

## 3. 機能要件

### 3.1 機能一覧

**※ REQ-CLI-001の機能ID（F-001〜F-014）との連番を維持**

| ID | 機能名 | 概要 | 優先度 | フェーズ | 備考 |
|----|--------|------|--------|---------|------|
| F-005 | ~~BPM調節~~ | ~~テンポをオプションで調節可能~~ | - | - | **削除（MML内Tコマンドに統合）** |
| F-006 | ループ再生 | 演奏を繰り返し再生 | 必須 | Phase 1 | **修正: 履歴登録を追加** |
| F-012 | クリック音制御 | メトロノームのクリック音ON/OFF | 重要 | Phase 1 | **大幅変更: ノイズ音源、ビート選択、音量調節** |
| F-015 | ノイズベースクリック音 | ノイズを使ったハイハット風のクリック音 | 必須 | Phase 1.5 | **新規** |
| F-016 | ビート選択 | 16ビート、8ビート、4ビートの選択 | 必須 | Phase 1.5 | **新規** |
| F-017 | メトロノーム音量調節 | メトロノームの音量を個別に調節 | 必須 | Phase 1.5 | **新規** |
| F-018 | ループ履歴登録 | ループ再生時も履歴DBに保存 | 必須 | Phase 1.5 | **新規** |
| F-019 | 音声クリッピング防止 | 合成音の音量制限（ノーマライゼーション） | 必須 | Phase 1.5 | **新規** |
| F-020 | CLI-Backend対応マトリクス | 機能実装状況の可視化ドキュメント | 重要 | Phase 1.5 | **新規（開発品質向上）** |
| F-021 | E2E統合テスト | CLIレベルの自動テスト基盤 | 重要 | Phase 1.5 | **新規（開発品質向上）** |
| F-022 | PRテンプレート更新 | 統合テスト項目の追加 | 重要 | Phase 1.5 | **新規（開発品質向上）** |

### 3.2 ユーザーストーリー

#### US-006: ノイズベースのメトロノームでリズムを確認したい
- **ユーザー**: 作曲者
- **したいこと**: ノイズを使ったハイハット風のクリック音で演奏のリズムを確認したい
- **理由**: 既存のサイン波クリックより打楽器的な音でテンポ感を掴みやすい
- **受け入れ基準**:
  - [ ] `--metronome`オプション指定時、ノイズベースのクリック音が各拍で鳴る
  - [ ] クリック音は短く鋭い（ハイハット風）
  - [ ] 演奏音とメトロノーム音が混ざっても音割れしない
- **関連機能**: F-015, F-019

#### US-007: ビート刻みを選択したい
- **ユーザー**: 作曲者
- **したいこと**: 16ビート、8ビート、4ビートからクリック音の刻みを選びたい
- **理由**: 曲のテンポに合わせて細かさを調整したい（速い曲は4ビート、遅い曲は16ビート）
- **受け入れ基準**:
  - [ ] `--metronome-beat 4|8|16` オプションで選択可能
  - [ ] デフォルトは4ビート（4分音符ごと）
  - [ ] 16ビートでは16分音符ごとにクリック
- **関連機能**: F-016

#### US-008: メトロノームの音量を調節したい
- **ユーザー**: 作曲者
- **したいこと**: メトロノーム音量を演奏音と別に調節したい
- **理由**: 演奏音が小さいときはクリックも小さく、演奏音が大きいときはクリックも大きくしたい
- **受け入れ基準**:
  - [ ] `--metronome-volume 0.0-1.0` オプションで調節可能
  - [ ] デフォルトは 0.3（控えめ）
  - [ ] `--volume`（演奏音量）と独立して調節可能
- **関連機能**: F-017

#### US-009: ループ再生したMMLも履歴に残したい
- **ユーザー**: 開発者
- **したいこと**: `--loop`で再生したMMLも履歴に保存されてほしい
- **理由**: 気に入ったメロディをループで何度も聞いた後、履歴から再度呼び出したい
- **受け入れ基準**:
  - [ ] `--loop`指定時も履歴DBに保存される
  - [ ] Ctrl+Cで中断後、`sine-mml history`で確認できる
  - [ ] 履歴IDを使って再生可能
- **関連機能**: F-018

#### US-010: BPMオプションがなくても困らない
- **ユーザー**: 開発者
- **したいこと**: `--bpm`オプションが削除されても、MML内のTコマンドで対応したい
- **理由**: オプションとMMLコマンドが重複していて混乱する
- **受け入れ基準**:
  - [ ] `--bpm`オプションが削除されている
  - [ ] `sine-mml play "T180 CDEFGAB"` でテンポ指定可能
  - [ ] Tコマンドがない場合はデフォルト120 BPMで再生
  - [ ] ヘルプテキストに`--bpm`が表示されない
- **関連機能**: F-005（削除）

### 3.3 機能詳細

#### F-015: ノイズベースクリック音

**概要**: ホワイトノイズをベースにしたハイハット風のクリック音を生成

**入力**:
- BPM（MML内のTコマンドまたはデフォルト120）
- メトロノーム音量（`--metronome-volume`）

**出力**:
- ノイズベースのクリック音サンプル（短時間、鋭い減衰）

**処理概要**:
1. fundspの`noise()`関数でホワイトノイズを生成
2. 20-30ms程度の短い減衰エンベロープを適用（ハイハット風）
3. ハイパスフィルター（5kHz〜）で高音域を強調
4. メトロノーム音量係数を乗算

**ビジネスルール**:
- BR-030: クリック音の長さは20-30ms（固定）
- BR-031: ノイズは毎回異なる（シード固定しない）
- BR-032: ハイパスフィルターでローエンドをカット（音の重さ回避）

**制約事項**:
- fundspの`noise()`関数を使用（ホワイトノイズのみ）

**技術実装のポイント**:
```rust
// fundspを使ったノイズクリック音生成例
use fundsp::prelude::*;

fn generate_noise_click(sample_rate: f64, volume: f32) -> Vec<f32> {
    let duration = 0.025; // 25ms
    let num_samples = (duration * sample_rate) as usize;
    
    // ノイズ + ハイパスフィルター
    let mut node = noise() >> highpass_hz(5000.0, 1.0);
    node.set_sample_rate(sample_rate);
    
    let mut samples = Vec::with_capacity(num_samples);
    for i in 0..num_samples {
        let sample = node.get_mono() as f32;
        // 指数減衰エンベロープ
        let env = (-10.0 * (i as f32 / num_samples as f32)).exp();
        samples.push(sample * env * volume);
    }
    samples
}
```

---

#### F-016: ビート選択

**概要**: 4ビート、8ビート、16ビートからクリック音の刻みを選択

**入力**:
- `--metronome-beat 4|8|16` オプション（デフォルト: 4）

**出力**:
- 選択されたビートに応じたクリックタイミング

**処理概要**:
1. ビート値から1クリックあたりの音符長を計算（4ビート→4分音符、16ビート→16分音符）
2. 合成中、経過時間からクリック挿入位置を判定
3. クリックタイミングごとに`generate_noise_click`を呼び出し、サンプルバッファにミックス

**ビジネスルール**:
- BR-033: 4ビート = 4分音符ごと（デフォルト）
- BR-034: 8ビート = 8分音符ごと
- BR-035: 16ビート = 16分音符ごと
- BR-036: 無効な値（1, 2, 3, 5等）はエラー

**制約事項**:
- 4, 8, 16以外の値は受け付けない（clapのvalue_parserで検証）

**技術実装のポイント**:
```rust
// ビート計算例
fn beat_interval_seconds(bpm: u16, beat: u8) -> f32 {
    // 4分音符 = 60.0 / bpm 秒
    // 8分音符 = 30.0 / bpm 秒
    // 16分音符 = 15.0 / bpm 秒
    match beat {
        4 => 60.0 / bpm as f32,
        8 => 30.0 / bpm as f32,
        16 => 15.0 / bpm as f32,
        _ => unreachable!("validated by clap"),
    }
}
```

---

#### F-017: メトロノーム音量調節

**概要**: メトロノームの音量を演奏音と独立して調節

**入力**:
- `--metronome-volume 0.0-1.0` オプション（デフォルト: 0.3）

**出力**:
- 調整されたメトロノーム音量

**処理概要**:
1. クリック音生成時に音量係数を適用
2. 演奏音（`--volume`）とは独立したパラメータ

**ビジネスルール**:
- BR-037: 音量範囲は 0.0 - 1.0
- BR-038: デフォルトは 0.3（控えめ）
- BR-039: 範囲外の値は最も近い有効値にクランプ

**制約事項**:
- 演奏音量（`--volume`）と同じ範囲・検証ロジック

---

#### F-018: ループ履歴登録

**概要**: ループ再生時も履歴DBに保存

**入力**:
- `--loop`フラグ + MML文字列

**出力**:
- 履歴DBへの保存（通常再生と同じ）

**処理概要**:
1. `display_play_progress`の無限ループ前に履歴保存処理を実行
2. Ctrl+Cで中断されてもDBコミット済みの状態にする

**ビジネスルール**:
- BR-040: ループ再生でも新規MML入力時は履歴保存
- BR-041: 履歴IDからの再生（`--history-id`）時は保存しない（既存と同じ）

**制約事項**:
- Ctrl+C中断時のDB整合性を保証（トランザクション完了後にループ開始）

**技術実装のポイント**:
```rust
// 修正後のplay_handler疑似コード
pub fn play_handler(args: PlayArgs) -> Result<()> {
    // ... MML解析、音声合成 ...
    
    // 6. 履歴保存（ループ再生前に実行）
    if should_save {
        let history_id = db.save(&entry)?;
        output::success(&format!("✓ 履歴ID: {history_id}"));
    }
    
    // 4. 再生
    player.play(&buffer, args.loop_play)?;
    
    // 5. プログレス表示（ループ時は無限ループに入る）
    output::display_play_progress(&mml_string, &buffer, args.loop_play)?;
    
    Ok(())
}
```

---

#### F-019: 音声クリッピング防止

**概要**: メトロノーム+演奏の合成時に音量を制限（ノーマライゼーション）

**入力**:
- 合成後のPCMサンプルバッファ

**出力**:
- ノーマライズされたサンプルバッファ（最大絶対値が1.0以下）

**処理概要**:
1. サンプルバッファの最大絶対値を検出
2. 最大値が1.0を超える場合、全サンプルを比例縮小
3. 最大値が1.0以下の場合は何もしない（音量を上げない）

**ビジネスルール**:
- BR-042: 最大絶対値が1.0を超える場合のみノーマライズ
- BR-043: ノーマライズは全サンプルに均等に適用（歪み防止）
- BR-044: デジタルクリッピング（±1.0を超える値）を完全に防止

**制約事項**:
- f32の精度範囲内で処理（±1.0を厳密に守る）

**技術実装のポイント**:
```rust
fn normalize_samples(samples: &mut [f32]) {
    let max_abs = samples.iter()
        .map(|s| s.abs())
        .fold(0.0_f32, f32::max);
    
    if max_abs > 1.0 {
        let scale = 1.0 / max_abs;
        samples.iter_mut().for_each(|s| *s *= scale);
    }
}
```

---

#### F-020: CLI-Backend対応マトリクス

**概要**: CLIオプションとバックエンド実装の対応関係を可視化するドキュメント

**入力**:
- 全CLIオプション（`--waveform`, `--volume`, `--metronome`等）
- バックエンドモジュール（`audio::synthesizer`, `db::history`等）

**出力**:
- `docs/capabilities.md` ファイル

**処理概要**:
1. CLIオプションを列挙
2. 各オプションの実装状態（Implemented / Stub / Planned）を記載
3. バックエンドの対応メソッド/関数を明記
4. 未実装機能は「Stub」として視覚的に強調

**ビジネスルール**:
- BR-045: 全CLIオプションを漏れなく記載
- BR-046: 実装状態は3段階（Implemented, Stub, Planned）
- BR-047: 更新頻度: 新機能追加時、PR作成前

**出力形式例**:
```markdown
# CLI-Backend Capability Matrix

| CLI Option | Backend Method | Status | Notes |
|-----------|---------------|--------|-------|
| `--waveform` | `Synthesizer::new(waveform_type)` | ✅ Implemented | 波形選択機能 |
| `--volume` | `Synthesizer::new(volume)` | ✅ Implemented | 音量調節 |
| `--metronome` | `Synthesizer::synthesize(metronome)` | ⚠️ Stub | F-015で実装予定 |
| `--bpm` | - | ❌ Deleted | MML内Tコマンドに統合 |
```

---

#### F-021: E2E統合テスト

**概要**: CLIバイナリレベルの自動テスト基盤構築

**入力**:
- テストシナリオ（コマンドライン引数、期待される出力/副作用）

**出力**:
- `tests/cli_integration.rs` ファイル
- 合格/不合格の判定

**処理概要**:
1. `assert_cmd`クレートで`sine-mml`バイナリを実行
2. 標準出力、標準エラー出力、終了コードを検証
3. 副作用（DB保存、WAVファイル生成）を検証

**ビジネスルール**:
- BR-048: 主要シナリオ（play, history, export）を100%カバー
- BR-049: CI/CDで自動実行
- BR-050: テスト失敗時はPRマージ不可

**テストシナリオ例**:
```rust
#[test]
fn test_play_with_metronome() {
    let mut cmd = Command::cargo_bin("sine-mml").unwrap();
    cmd.arg("play")
       .arg("C4 D4 E4")
       .arg("--metronome")
       .arg("--metronome-beat").arg("16");
    cmd.assert().success();
}

#[test]
fn test_loop_saves_history() {
    let mut cmd = Command::cargo_bin("sine-mml").unwrap();
    cmd.arg("play")
       .arg("CDEFGAB")
       .arg("--loop")
       .timeout(Duration::from_secs(2));
    // Ctrl+C相当の中断
    
    // 履歴DB確認
    let db = Database::init().unwrap();
    let history = db.get_all().unwrap();
    assert!(history.iter().any(|e| e.mml == "CDEFGAB"));
}
```

---

#### F-022: PRテンプレート更新

**概要**: PRテンプレートに統合テスト項目を追加

**入力**:
- 現在の`.github/pull_request_template.md`

**出力**:
- 更新された`.github/pull_request_template.md`

**処理概要**:
1. 既存のチェックリストに「統合テスト」項目を追加
2. CLIオプション変更時の必須確認事項を明記

**ビジネスルール**:
- BR-051: CLIオプション追加/変更時は統合テスト必須
- BR-052: Capability Matrix更新も必須

**追加項目例**:
```markdown
## Checklist
- [ ] 単体テスト（`cargo test`）が通過
- [ ] 統合テスト（`cargo test --test cli_integration`）が通過
- [ ] CLIオプション変更時: `docs/capabilities.md` を更新
- [ ] 実際のバイナリで動作確認（`cargo run -- play "CDEFGAB"`）
```

---

## 4. 非機能要件

### 4.1 性能要件

| ID | 要件 | 目標値 | 測定方法 |
|----|------|--------|----------|
| NFR-P-005 | ノーマライゼーションのオーバーヘッド | 5%以内（合成時間の） | ベンチマーク |
| NFR-P-006 | メトロノームミックスのレイテンシ | 増加なし（既存と同等） | オーディオバッファ測定 |
| NFR-P-007 | ループ履歴保存の追加レイテンシ | 50ms以内 | DB保存時間測定 |

### 4.2 可用性要件

| ID | 要件 | 目標値 |
|----|------|--------|
| NFR-A-003 | メトロノーム有効時のクラッシュ率 | 0% |
| NFR-A-004 | ノーマライゼーション失敗時のフォールバック | 警告表示 + 元の音量で再生 |

### 4.3 セキュリティ要件

| ID | 要件 | 詳細 |
|----|------|------|
| NFR-S-004 | メトロノーム音量の範囲検証 | 0.0-1.0に制限（clapで検証） |
| NFR-S-005 | ビート値の検証 | 4, 8, 16のみ許可（それ以外はエラー） |

### 4.4 ユーザビリティ要件

| ID | 要件 | 詳細 |
|----|------|------|
| NFR-U-005 | メトロノームのデフォルト値 | 音量0.3、4ビート（控えめで邪魔にならない） |
| NFR-U-006 | ヘルプテキストの明確性 | `--help`で全メトロノームオプションを説明 |
| NFR-U-007 | エラーメッセージ | 無効なビート値時に「4, 8, 16のいずれかを指定してください」と表示 |

### 4.5 保守性要件

| ID | 要件 | 詳細 |
|----|------|------|
| NFR-M-005 | E2Eテストカバレッジ | 主要シナリオ100%（play, history, export） |
| NFR-M-006 | Capability Matrixの更新頻度 | CLI変更時に必ず更新（PRチェックリスト化） |
| NFR-M-007 | コードドキュメント | ノーマライゼーション関数にアルゴリズム説明コメント |

---

## 5. 制約条件

### 5.1 技術的制約

| 制約 | 詳細 | 理由 |
|------|------|------|
| ノイズ生成 | fundspの`noise()`関数を使用 | 既存ライブラリとの一貫性 |
| テストフレームワーク | assert_cmd, predicates | Rust CLI標準、豊富な機能 |
| 後方互換性 | `--bpm`削除は破壊的変更 | メジャーバージョンアップ（v2.0.0）で実施 |
| DB互換性 | 既存の履歴テーブルスキーマ維持 | マイグレーション不要 |

### 5.2 ビジネス制約

| 制約 | 詳細 |
|------|------|
| スケジュール | Phase 1.5: 2週間（v2.0.0リリース） |
| リソース | 個人開発（1名） |
| 予算 | オープンソース（無償） |

### 5.3 法規制・コンプライアンス

| 要件 | 詳細 |
|------|------|
| ライセンス | MIT License（変更なし） |
| 破壊的変更の告知 | CHANGELOG.mdに明記、GitHub Releaseで周知 |

---

## 6. 外部インターフェース

### 6.1 既存機能への影響

| 機能ID | 機能名 | 影響内容 | 対応 |
|--------|--------|----------|------|
| F-005 | BPM調節 | **削除** | `--bpm`オプションを削除、ヘルプテキスト更新 |
| F-006 | ループ再生 | **修正** | 履歴保存タイミングを変更 |
| F-012 | クリック音制御 | **大幅変更** | 実装を追加（スタブ→完全実装） |

### 6.2 CLIインターフェース変更

#### 削除されるオプション
```bash
# 削除（v2.0.0以降）
--bpm <BPM>
```

#### 追加されるオプション
```bash
# メトロノーム関連
--metronome              # 既存（機能強化）
--metronome-beat <4|8|16>  # 新規（デフォルト: 4）
--metronome-volume <0.0-1.0>  # 新規（デフォルト: 0.3）
```

#### 変更なし
```bash
--waveform <sine|sawtooth|square>
--volume <0.0-1.0>
--loop
--history-id <ID>
```

---

## 7. 前提条件と依存関係

### 7.1 前提条件

- REQ-CLI-001の全機能が実装済み（v1.0.0リリース済み）
- fundsp 0.18+ がノイズ生成とフィルターに対応している
- rusqlite のトランザクションが正常に動作する

### 7.2 依存関係

| 依存先 | 内容 | 影響 |
|--------|------|------|
| fundsp | `noise()`, `highpass_hz()` 関数 | メトロノーム音源生成 |
| assert_cmd | CLIテスト実行 | E2Eテスト基盤 |
| predicates | 出力アサーション | E2Eテスト検証 |

### 7.3 新規依存クレート

```toml
[dev-dependencies]
assert_cmd = "2.0"
predicates = "3.0"
```

---

## 8. リスクと課題

### 8.1 リスク一覧

| ID | リスク | 影響度 | 発生確率 | 対策 |
|----|--------|--------|---------|------|
| R-005 | `--bpm`削除による既存ユーザーの混乱 | 高 | 高 | CHANGELOG、マイグレーションガイド作成 |
| R-006 | メトロノーム+演奏の合成で音質劣化 | 中 | 中 | ノーマライゼーション比率の調整、リスニングテスト |
| R-007 | fundspのノイズ生成が期待と異なる | 中 | 低 | 事前検証、代替案（手動ノイズ生成）準備 |
| R-008 | ループ履歴保存でDB肥大化 | 低 | 中 | 定期的な履歴クリーンアップ機能（将来検討） |
| R-009 | E2Eテストの実行時間増加 | 低 | 中 | 並列実行、CI最適化 |

### 8.2 未解決課題

| ID | 課題 | 担当 | 期限 |
|----|------|------|------|
| I-005 | fundspのノイズ+フィルター動作確認 | 開発チーム | 2026-01-14 |
| I-006 | ノーマライゼーションの音質評価 | 開発チーム | 2026-01-17 |
| I-007 | `--bpm`削除のマイグレーションガイド作成 | 開発チーム | 2026-01-20 |
| I-008 | E2Eテストの並列実行設定 | 開発チーム | 2026-01-24 |

---

## 9. 用語集

| 用語 | 定義 |
|------|------|
| クリッピング | デジタル音声の振幅が±1.0を超えて歪む現象 |
| ノーマライゼーション | 音声の最大振幅を基準値（通常1.0）に揃える処理 |
| ビート | 拍の刻み方（4ビート=4分音符、16ビート=16分音符） |
| スタブ | インターフェースのみ存在し、実装が空の機能 |
| E2E（End-to-End）テスト | システム全体を通した統合テスト |
| Capability Matrix | 機能の実装状況を一覧化した対応表 |
| ハイパスフィルター | 低周波数をカットし高周波数を通すフィルター |
| fundsp | Rust製DSPライブラリ（波形生成・フィルター処理） |

---

## 10. 参考リンク

### 10.1 技術資料

#### Rustオーディオライブラリ
- **fundspノイズ生成**: [fundsp::prelude::noise](https://docs.rs/fundsp/latest/fundsp/prelude/fn.noise.html)
- **fundspフィルター**: [fundsp::prelude::highpass_hz](https://docs.rs/fundsp/latest/fundsp/prelude/fn.highpass_hz.html)
- **augmented-audio-libraries**: [Metronome実装例](https://github.com/yamadapc/augmented-audio/tree/master/crates/apps/metronome)
- **audio-processor-metronome**: [Rustメトロノームクレート](https://docs.rs/audio-processor-metronome/latest/audio_processor_metronome/)

#### Rust CLIテスト
- **assert_cmd**: [CLIテストフレームワーク](https://docs.rs/assert_cmd/)
- **predicates**: [アサーションライブラリ](https://docs.rs/predicates/)

### 10.2 ベストプラクティス

#### メトロノーム実装
- [Simple Metronome - Beijaflor Software](https://beijaflor.io/blog/01-2022/rust-audio-experiments-3/) - Rust + Flutterメトロノーム実装例
- [Kira Audio Engine](https://docs.rs/kira/latest/kira/clock/index.html) - クロック/タイミング管理の参考

#### 音声処理
- ノイズベースのクリック音: ハイパスフィルター（5kHz〜）で明瞭度向上
- ノーマライゼーション: ピークリミッター方式（最大値で除算）が一般的

---

## 11. 実装優先順位と段階的ロールアウト

### Phase 1.5.1（Week 1: 2026-01-11〜01-17）
1. **F-019（音声クリッピング防止）** - 基盤として最優先
   - `normalize_samples`関数実装
   - 既存の`synthesize`に統合
2. **F-015（ノイズベースクリック音）** - コア機能
   - `generate_noise_click`実装
   - fundspのノイズ+フィルター検証
3. **F-018（ループ履歴登録）** - 簡単な修正
   - `play_handler`の処理順序変更

### Phase 1.5.2（Week 2: 2026-01-18〜01-24）
4. **F-016（ビート選択）** - メトロノーム拡張
   - `--metronome-beat`オプション追加
   - ビート計算ロジック実装
5. **F-017（メトロノーム音量調節）** - メトロノーム拡張
   - `--metronome-volume`オプション追加
6. **F-005（BPM調節削除）** - 破壊的変更
   - `--bpm`削除
   - CHANGELOG、マイグレーションガイド作成
7. **F-020, F-021, F-022（開発品質向上）** - ドキュメント・テスト
   - `docs/capabilities.md`作成
   - `tests/cli_integration.rs`作成
   - PRテンプレート更新

---

## 12. 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|----------|--------|
| 1.0.0 | 2026-01-11 | 初版作成 | req-writer |
