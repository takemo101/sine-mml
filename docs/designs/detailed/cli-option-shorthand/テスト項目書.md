# DET-CLI-007 CLIオプションショートハンド拡充 テスト項目書

## 0. ドキュメント情報

| 項目 | 内容 |
|------|------|
| ドキュメントID | DET-CLI-007-TEST |
| バージョン | 1.0.0 |
| ステータス | ドラフト |
| 作成日 | 2026-01-15 |
| 最終更新日 | 2026-01-15 |
| 作成者 | test-spec-writer |
| 関連文書 | DET-CLI-007-001_詳細設計書.md (v1.1.0)<br>DET-CLI-007-002_バックエンド設計書.md (v1.1.0) |

---

## 1. テスト概要

### 1.1 テスト目的

CLIオプションショートハンド拡充機能（F-033〜F-036）が設計書通りに動作することを検証する。

### 1.2 テスト範囲

| 機能ID | 機能名 | テスト対象 |
|--------|--------|-----------|
| F-033 | 履歴スキップオプション | `--no-history` / `-N` オプション |
| F-034 | MIDI出力と履歴スキップの併用 | `--midi-out` + `--no-history` |
| F-035 | MIDI出力とループ再生の併用 | `--midi-out` + `--loop-play` |
| F-036 | MIDI出力時のプログレスバー表示 | `--midi-out` 単独時のプログレスバー |

### 1.3 テストレベル

| レベル | 対象 | カバレッジ目標 |
|--------|------|---------------|
| ユニットテスト | CLIオプション解析、履歴保存条件、時間計算 | 100% |
| 統合テスト | オプション併用、履歴DB連携 | 100% |
| E2Eテスト | 主要シナリオ | 100% |

---

## 2. ユニットテスト項目

### 2.1 CLIオプション解析（src/cli/args.rs）

| テストID | テスト名 | 入力 | 期待結果 | 関連BR |
|---------|---------|------|----------|--------|
| UT-033-001 | --no-history長形式パース | `play "CDE" --no-history` | `args.no_history == true` | BR-105 |
| UT-033-002 | -N短形式パース | `play "CDE" -N` | `args.no_history == true` | BR-106 |
| UT-033-003 | デフォルト値確認 | `play "CDE"` | `args.no_history == false` | BR-107 |
| UT-033-004 | MIDI出力との併用パース | `play "CDE" --midi-out 0 --no-history` | 両オプションが正常にパース | BR-110 |
| UT-033-005 | ループ再生との併用パース | `play "CDE" --loop-play --no-history` | 両オプションが正常にパース | - |
| UT-033-006 | 全オプション併用パース | `play "CDE" --midi-out 0 --loop-play -N` | 全オプションが正常にパース | - |

### 2.2 履歴保存判定（src/cli/handlers.rs）

| テストID | テスト名 | 入力条件 | 期待結果 | 関連BR |
|---------|---------|---------|----------|--------|
| UT-033-007 | no_history=trueで保存スキップ | `no_history=true, mml=Some` | `determine_should_save() == false` | BR-105 |
| UT-033-008 | no_history=falseで保存実行 | `no_history=false, mml=Some` | `determine_should_save() == true` | BR-107 |
| UT-033-009 | history_id指定で保存スキップ | `no_history=false, history_id=Some` | `determine_should_save() == false` | - |
| UT-033-010 | no_history+history_idで保存スキップ | `no_history=true, history_id=Some` | `determine_should_save() == false` | BR-105 |

### 2.3 全体時間計算（src/midi/player.rs）

| テストID | テスト名 | 入力MML | 期待結果（±100ms） | 関連BR |
|---------|---------|--------|-------------------|--------|
| UT-036-001 | 単純音符の時間計算 | `T120 L4 CDEF` | 2000ms | BR-118 |
| UT-036-002 | 休符を含む時間計算 | `T120 L4 CRC` | 1500ms | BR-118 |
| UT-036-003 | 空コマンドの時間計算 | `[]` | 0ms | BR-118 |
| UT-036-004 | テンポ変更の時間計算 | `T60 L4 C T120 C` | 1500ms | BR-118 |
| UT-036-005 | コードの時間計算 | `T120 L4 [CEG]` | 500ms | BR-118 |
| UT-036-006 | 連符の時間計算 | `T120 {CDE}4` | 500ms | BR-118 |
| UT-036-007 | 複雑MMLの時間計算 | `T120 L4 C [CEG] R {DEF}4` | 2000ms | BR-118 |

---

## 3. 統合テスト項目

### 3.1 履歴スキップ機能（F-033）

| テストID | テスト名 | コマンド | 期待結果 | 関連BR |
|---------|---------|---------|----------|--------|
| IT-033-001 | 長形式で履歴スキップ | `play "CDE" --no-history` | 再生成功、履歴に保存されない | BR-105 |
| IT-033-002 | 短形式で履歴スキップ | `play "CDE" -N` | 再生成功、履歴に保存されない | BR-106 |
| IT-033-003 | 従来動作（履歴保存） | `play "CDE"` | 再生成功、履歴に保存される | BR-107 |
| IT-033-004 | ファイル読込+履歴スキップ | `play -f test.mml --no-history` | 再生成功、履歴に保存されない | BR-105 |
| IT-033-005 | 履歴ID再生+履歴スキップ | `play --history-id 1 --no-history` | 再生成功、新規履歴は追加されない | BR-105 |
| IT-033-006 | note併用時の警告表示 | `play "CDE" --no-history --note "Test"` | 警告表示、履歴に保存されない | BR-109 |

### 3.2 MIDI出力と履歴スキップの併用（F-034）

| テストID | テスト名 | コマンド | 期待結果 | 関連BR |
|---------|---------|---------|----------|--------|
| IT-034-001 | MIDI出力+履歴スキップ（長形式） | `play "CDE" --midi-out 0 --no-history` | MIDI出力成功、履歴に保存されない | BR-110, BR-111 |
| IT-034-002 | MIDI出力+履歴スキップ（短形式） | `play "CDE" --midi-out 0 -N` | MIDI出力成功、履歴に保存されない | BR-110, BR-111 |
| IT-034-003 | MIDI出力のみ（従来動作） | `play "CDE" --midi-out 0` | MIDI出力成功、履歴に保存される | BR-110 |
| IT-034-004 | 波形+MIDI+履歴スキップ | `play "CDE" -w sine --midi-out 0 --no-history` | 両方で再生成功、履歴に保存されない | BR-112 |

### 3.3 MIDI出力とループ再生の併用（F-035）

| テストID | テスト名 | コマンド | 期待結果 | 関連BR |
|---------|---------|---------|----------|--------|
| IT-035-001 | MIDI出力+ループ再生 | `play "CDE" --midi-out 0 --loop-play` | MIDI出力がループ再生される | BR-113, BR-114 |
| IT-035-002 | MIDI+ループ+履歴スキップ | `play "CDE" --midi-out 0 --loop-play --no-history` | ループ再生、履歴に保存されない | BR-113, BR-114 |
| IT-035-003 | 波形+MIDI+ループ | `play "CDE" -w sine --midi-out 0 --loop-play` | 両方がループ再生される | BR-116 |
| IT-035-004 | Ctrl+Cでの正常終了 | `play "CDE" --midi-out 0 --loop-play` + Ctrl+C | 全MIDIノートオフ送信、正常終了 | BR-115 |

### 3.4 MIDI出力時のプログレスバー表示（F-036）

| テストID | テスト名 | コマンド | 期待結果 | 関連BR |
|---------|---------|---------|----------|--------|
| IT-036-001 | MIDI出力でプログレスバー表示 | `play "CDE" --midi-out 0` | プログレスバーが表示される | BR-117 |
| IT-036-002 | ループ再生でプログレスバーなし | `play "CDE" --midi-out 0 --loop-play` | プログレスバーは表示されない | BR-119 |
| IT-036-003 | 波形+MIDI出力でプログレスバー | `play "CDE" -w sine --midi-out 0` | プログレスバーが表示される | BR-120 |
| IT-036-004 | MIDI+履歴スキップでプログレスバー | `play "CDE" --midi-out 0 --no-history` | プログレスバー表示、履歴保存なし | BR-117 |
| IT-036-005 | プログレスバー更新確認 | `play "T60 L1 CDEFGAB" --midi-out 0` | 0%→100%に徐々に更新される | BR-118 |

---

## 4. E2Eテスト項目

### 4.1 主要シナリオテスト

| テストID | シナリオ名 | 手順 | 期待結果 |
|---------|-----------|------|----------|
| E2E-033-001 | 開発中のテスト演奏 | 1. `play "CDE" -N` を実行<br>2. `history` で履歴確認 | 履歴に追加されていない |
| E2E-033-002 | 本番演奏（履歴保存） | 1. `play "CDE"` を実行<br>2. `history` で履歴確認 | 履歴に追加されている |
| E2E-034-001 | MIDIテスト演奏 | 1. `play "CDE" --midi-out 0 -N` を実行<br>2. MIDIデバイスで音を確認<br>3. `history` で履歴確認 | MIDI出力成功、履歴なし |
| E2E-035-001 | MIDIループ演奏 | 1. `play "CDE" --midi-out 0 --loop-play` を実行<br>2. Ctrl+C で停止 | ループ再生後、正常終了 |
| E2E-036-001 | MIDIプログレスバー確認 | 1. `play "T60 L1 CDEFGAB" --midi-out 0` を実行<br>2. プログレスバーを目視確認 | プログレスバーが0%→100%に更新 |

### 4.2 エッジケーステスト

| テストID | シナリオ名 | 手順 | 期待結果 |
|---------|-----------|------|----------|
| E2E-033-003 | 警告メッセージ確認 | `play "CDE" -N --note "Test"` | 警告メッセージが表示される |
| E2E-033-004 | ヘルプメッセージ確認 | `play --help` | `-N, --no-history` の説明が表示される |
| E2E-036-002 | 短いMMLでのプログレスバー | `play "C" --midi-out 0` | プログレスバーが高速に完了 |
| E2E-036-003 | 長いMMLでのプログレスバー | `play "T60 L1 CDEFGABCDEFGAB" --midi-out 0` | プログレスバーがゆっくり進行 |

---

## 5. 非機能テスト項目

### 5.1 パフォーマンステスト

| テストID | テスト名 | 測定項目 | 目標値 | 関連NFR |
|---------|---------|---------|--------|---------|
| NFT-P-001 | オプション解析オーバーヘッド | `--no-history` 追加によるパース時間増加 | 1ms以内 | NFR-P-019 |
| NFT-P-002 | 履歴スキップ効果測定 | 履歴保存スキップによる時間短縮 | 約5ms短縮 | NFR-P-020 |
| NFT-P-003 | プログレスバーCPU使用率 | プログレスバー表示中のCPU使用率 | 5%以下 | NFR-P-021 |
| NFT-P-004 | プログレスバー更新頻度 | プログレスバーの更新間隔 | 100ms以下 | NFR-P-022 |

### 5.2 互換性テスト

| テストID | テスト名 | 確認項目 | 期待結果 | 関連NFR |
|---------|---------|---------|----------|---------|
| NFT-C-001 | 後方互換性確認 | 既存コマンドの動作 | 従来通り動作 | NFR-C-001 |
| NFT-C-002 | オプション独立性確認 | 各オプションの独立動作 | 相互に影響しない | NFR-C-002 |

---

## 6. テスト環境

### 6.1 必要環境

| 項目 | 要件 |
|------|------|
| OS | Linux / macOS / Windows |
| Rust | 1.70+ |
| MIDIデバイス | 仮想MIDIデバイス（IT-034, IT-035, IT-036用） |
| データベース | SQLite（インメモリ可） |

### 6.2 テストデータ

| データ | 内容 |
|--------|------|
| test.mml | `T120 L4 CDEFGAB` |
| 履歴データ | テスト用の履歴エントリ（ID=1） |

---

## 7. テスト実行計画

### 7.1 実行順序

1. ユニットテスト（UT-*）
2. 統合テスト（IT-*）
3. E2Eテスト（E2E-*）
4. 非機能テスト（NFT-*）

### 7.2 合格基準

| レベル | 合格基準 |
|--------|---------|
| ユニットテスト | 全件パス |
| 統合テスト | 全件パス |
| E2Eテスト | 全件パス |
| 非機能テスト | 全件目標値達成 |

---

## 8. 変更履歴

| バージョン | 日付 | 変更内容 | 担当者 |
|-----------|------|----------|--------|
| 1.0.0 | 2026-01-15 | 初版作成 | test-spec-writer |
