# タイ記号（Tie）仕様追加

## 概要

MMLにおけるタイ記号（`&`）を実装し、同一音程の音符を連結して長い音を表現できるようにする。

## 背景

現状、sine-mmlでは以下の音長指定が可能:
- 数値指定: `C4`（4分音符）、`C8`（8分音符）
- 付点: `C4.`（付点4分音符 = 4分 + 8分）

しかし、付点では表現できない音長（例: 4分 + 16分 = 5/16拍）や、小節をまたぐ長い音を表現する手段がない。

## 提案仕様

### 基本構文

```
<音符>&<音符>
```

タイ記号 `&` で同一音程の音符を連結し、音長を合算する。

### 使用例

```mml
# 4分音符 + 8分音符 = 付点4分音符相当
C4&8

# 8分音符 + 8分音符 = 4分音符相当
C8&8

# 4分音符 + 16分音符（付点では表現不可）
C4&16

# 複数連結も可能
C4&8&16

# 小節をまたぐ長い音の表現
C1&1  # 全音符2つ分 = 2小節分
```

### ビジネスルール

| ルールID | 内容 |
|---------|------|
| BR-TIE-001 | タイで連結できるのは同一音程の音符のみ |
| BR-TIE-002 | 異なる音程のタイはエラー（例: `C4&D4` は不可） |
| BR-TIE-003 | 休符のタイは許可（`R4&8` = 付点4分休符相当） |
| BR-TIE-004 | タイ後の音符に付点も指定可能（`C4&8.`） |
| BR-TIE-005 | タイの連鎖は無制限（`C4&8&16&32` など） |
| BR-TIE-006 | タイ記号の前後に空白があっても許可（`C4 & 8`） |

### 動作詳細

#### 音長の計算

タイで連結された音符は、各音符の音長を合算した1つの音として発音される。

```
C4&8 の音長計算:
- C4 = 1/4 拍
- C8 = 1/8 拍
- 合計 = 1/4 + 1/8 = 3/8 拍
```

#### 同一音程の検証

```mml
C4&8      # OK: 同一音程（C）
C#4&8     # OK: 同一音程（C#）
C4&C8     # OK: 音程を明示的に指定しても同一なら可
C4&D4     # ERROR: 異なる音程
C4&R4     # ERROR: 音符と休符のタイは不可
```

### エラーケース

| エラーコード | 条件 | メッセージ例 |
|-------------|------|-------------|
| MML-E012 | 異なる音程のタイ | `Tie must connect notes of the same pitch at position 3` |
| MML-E013 | タイの後に音符がない | `Expected note after tie at position 5` |
| MML-E014 | 音符と休符のタイ | `Cannot tie note and rest at position 3` |

## 実装方針

### 1. トークナイザー変更

新しいトークン `Tie` を追加:

```rust
pub enum Token {
    // ... 既存トークン
    Tie,  // &
}
```

### 2. AST変更

`Note` 構造体を拡張してタイ情報を保持:

```rust
pub struct Note {
    pub pitch: Pitch,
    pub accidental: Option<Accidental>,
    pub duration: Option<u8>,
    pub dots: u8,
    pub tied_durations: Vec<TiedDuration>,  // 追加
}

pub struct TiedDuration {
    pub duration: Option<u8>,
    pub dots: u8,
}
```

または、`Command::TiedNote` として別コマンドにする選択肢もある。

### 3. パーサー変更

`parse_note()` でタイ記号を検出し、後続の音符を連結:

```rust
fn parse_note(&mut self) -> Result<Note, ParseError> {
    let base_note = self.parse_single_note()?;
    
    // タイ記号のチェック
    while self.check(Token::Tie) {
        self.advance(); // & を消費
        let tied_note = self.parse_tied_note(&base_note)?;
        // 音程の検証
        // 音長情報を追加
    }
    
    Ok(base_note)
}
```

### 4. シンセサイザー変更

`duration_in_seconds()` でタイ情報を考慮:

```rust
pub fn duration_in_seconds(&self, bpm: u16, default_length: u8) -> f32 {
    let base_duration = self.calculate_base_duration(bpm, default_length);
    let tied_duration: f32 = self.tied_durations
        .iter()
        .map(|td| td.calculate_duration(bpm, default_length))
        .sum();
    
    base_duration + tied_duration
}
```

## 代替案

### 案A: `&` をタイ記号として使用（推奨）

一般的なMML実装で広く使われている。

### 案B: `^` をタイ記号として使用

一部のMML実装（PMDなど）で使用されている。`&` と `^` の両方をサポートすることも可能。

### 案C: 連続した同一音符を自動タイ

`CC` のように同一音符が連続した場合に自動的にタイとして扱う。ただし、これは既存の動作（別々の音として発音）と互換性がない。

## 影響範囲

| ファイル | 変更内容 |
|---------|---------|
| `src/mml/mod.rs` | `Tie` トークン追加 |
| `src/mml/ast.rs` | `Note` 構造体拡張または `TiedNote` 追加 |
| `src/mml/parser.rs` | タイ解析ロジック追加 |
| `src/mml/error.rs` | タイ関連エラー追加 |
| `src/audio/synthesizer.rs` | 音長計算の拡張 |
| `README.md` | 構文リファレンス更新 |
| `USAGE.md` | タイの使い方セクション追加 |

## テストケース

### 正常系

| 入力 | 期待される音長 |
|------|---------------|
| `C4&8` | 3/8 拍 |
| `C8&8` | 1/4 拍（C4相当） |
| `C4&4` | 1/2 拍（C2相当） |
| `C4.&8` | 7/16 拍 |
| `C4&8.` | 7/16 拍 |
| `C4&8&16` | 7/16 拍 |
| `R4&8` | 3/8 拍の休符 |

### 異常系

| 入力 | エラー |
|------|--------|
| `C4&D4` | MML-E012: 異なる音程 |
| `C4&` | MML-E013: タイ後に音符がない |
| `C4&R4` | MML-E014: 音符と休符のタイ |
| `&C4` | MML-E013: タイの前に音符がない |

## 優先度

中（既存機能を壊さず、表現力を向上させる新機能）

## 参考

- [PPMCK MML Reference](http://ppmck.wikidot.com/mml-command-reference)
- [MML (Music Macro Language) - Wikipedia](https://en.wikipedia.org/wiki/Music_Macro_Language)
